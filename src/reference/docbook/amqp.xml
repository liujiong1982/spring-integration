<?xml version="1.0" encoding="UTF-8"?>
<chapter xmlns="http://docbook.org/ns/docbook" version="5.0" xml:id="amqp"
    xmlns:xlink="http://www.w3.org/1999/xlink">
  <title>AMQP Support</title>

  <section id="amqp-introduction">
    <title>Introduction</title>

    <para>
        Spring Integration provides Channel Adapters for receiving and sending
        messages using the Advanced Message Queuing Protocol (AMQP).

        The following adapters are available:
	    <itemizedlist>
	        <listitem>Inbound Channel Adapter</listitem>
			<listitem>Outbound Channel Adapter</listitem>
			<listitem>Inbound Gateway</listitem>
			<listitem>Outbound Gateway</listitem>
	    </itemizedlist>
    </para>
	<para>
		Spring Integration also provides a point-to-point Message Channel as well as a
		publish/subscribe Message Channel backed by AMQP Exchanges and Queues.
	</para>
    <para>
        In order to provide AMQP support, Spring Integration relies on Spring AMQP
        (<ulink url="http://www.springsource.org/spring-amqp">http://www.springsource.org/spring-amqp</ulink>)
        which "applies core Spring concepts to the development of AMQP-based
        messaging solutions". Spring AMQP provides similar semantics as Spring JMS
        (<ulink url="http://static.springsource.org/spring/docs/current/spring-framework-reference/html/jms.html">http://static.springsource.org/spring/docs/current/spring-framework-reference/html/jms.html</ulink>).
    </para>
    <para>
        Whereas the provided AMQP Channel Adapters are intended for unidirectional
        Messaging (send or receive) only, Spring Integration also provides inbound
        and outbound AMQP Gateways for request/reply operations.
    </para>
    <tip>
        <para>
            Please familiarize yourself with the reference documentation of
            the Spring AMQP project as well. It provides much more in-depth information
            regarding Spring's integration with AMQP in general and RabbitMQ in
            particular.</para>
        <para>You can find the documentation at:
              <ulink url="http://static.springsource.org/spring-amqp/reference/html/">
                  http://static.springsource.org/spring-amqp/reference/html/</ulink>
        </para>
    </tip>
  </section>

  <section id="amqp-inbound-channel-adapter">
    <title>Inbound Channel Adapter</title>

    <para>A configuration sample for an AMQP Inbound Channel Adapter is shown
          below.</para>
    <programlisting language="xml"><![CDATA[<int-amqp:inbound-channel-adapter
                                  id="inboundAmqp"]]><co        		id="amqp-inbound-channel-adapter-xml-01-co"	linkends="amqp-inbound-channel-adapter-xml-01" /><![CDATA[
                                  channel="inboundChannel"]]><co        id="amqp-inbound-channel-adapter-xml-02-co" linkends="amqp-inbound-channel-adapter-xml-02" /><![CDATA[
                                  queue-names="si.test.queue"]]><co     id="amqp-inbound-channel-adapter-xml-03-co" linkends="amqp-inbound-channel-adapter-xml-03" /><![CDATA[
                                  acknowledge-mode="AUTO"]]><co         id="amqp-inbound-channel-adapter-xml-04-co" linkends="amqp-inbound-channel-adapter-xml-04" /><![CDATA[
                                  advice-chain=""]]><co                 id="amqp-inbound-channel-adapter-xml-05-co" linkends="amqp-inbound-channel-adapter-xml-05" /><![CDATA[
                                  channel-transacted=""]]><co           id="amqp-inbound-channel-adapter-xml-06-co" linkends="amqp-inbound-channel-adapter-xml-06" /><![CDATA[
                                  concurrent-consumers=""]]><co         id="amqp-inbound-channel-adapter-xml-07-co" linkends="amqp-inbound-channel-adapter-xml-07" /><![CDATA[
                                  connection-factory=""]]><co           id="amqp-inbound-channel-adapter-xml-08-co" linkends="amqp-inbound-channel-adapter-xml-08" /><![CDATA[
                                  error-channel=""]]><co                id="amqp-inbound-channel-adapter-xml-09-co" linkends="amqp-inbound-channel-adapter-xml-09" /><![CDATA[
                                  expose-listener-channel=""]]><co      id="amqp-inbound-channel-adapter-xml-10-co" linkends="amqp-inbound-channel-adapter-xml-10" /><![CDATA[
                                  header-mapper=""]]><co                id="amqp-inbound-channel-adapter-xml-11-co" linkends="amqp-inbound-channel-adapter-xml-11" /><![CDATA[
                                  mapped-request-headers=""]]><co       id="amqp-inbound-channel-adapter-xml-12-co" linkends="amqp-inbound-channel-adapter-xml-12" /><![CDATA[
                                  listener-container=""]]><co           id="amqp-inbound-channel-adapter-xml-14-co" linkends="amqp-inbound-channel-adapter-xml-14" /><![CDATA[
                                  message-converter=""]]><co            id="amqp-inbound-channel-adapter-xml-15-co" linkends="amqp-inbound-channel-adapter-xml-15" /><![CDATA[
                                  message-properties-converter=""]]><co id="amqp-inbound-channel-adapter-xml-16-co" linkends="amqp-inbound-channel-adapter-xml-16" /><![CDATA[
                                  phase=""]]><co                        id="amqp-inbound-channel-adapter-xml-17-co" linkends="amqp-inbound-channel-adapter-xml-17" /><![CDATA[
                                  prefetch-count=""]]><co               id="amqp-inbound-channel-adapter-xml-18-co" linkends="amqp-inbound-channel-adapter-xml-18" /><![CDATA[
                                  receive-timeout=""]]><co              id="amqp-inbound-channel-adapter-xml-19-co" linkends="amqp-inbound-channel-adapter-xml-19" /><![CDATA[
                                  recovery-interval=""]]><co            id="amqp-inbound-channel-adapter-xml-20-co" linkends="amqp-inbound-channel-adapter-xml-20" /><![CDATA[
                                  missing-queues-fatal=""]]><co         id="amqp-inbound-channel-adapter-xml-20d-co" linkends="amqp-inbound-channel-adapter-xml-20d" /><![CDATA[
                                  shutdown-timeout=""]]><co             id="amqp-inbound-channel-adapter-xml-21-co" linkends="amqp-inbound-channel-adapter-xml-21" /><![CDATA[
                                  task-executor=""]]><co                id="amqp-inbound-channel-adapter-xml-22-co" linkends="amqp-inbound-channel-adapter-xml-22" /><![CDATA[
                                  transaction-attribute=""]]><co        id="amqp-inbound-channel-adapter-xml-23-co" linkends="amqp-inbound-channel-adapter-xml-23" /><![CDATA[
                                  transaction-manager=""]]><co          id="amqp-inbound-channel-adapter-xml-24-co" linkends="amqp-inbound-channel-adapter-xml-24" /><![CDATA[
                                  tx-size=""]]><co                      id="amqp-inbound-channel-adapter-xml-25-co" linkends="amqp-inbound-channel-adapter-xml-25" /><![CDATA[/>]]>
    </programlisting>
    <para>
        <calloutlist>
            <callout arearefs="amqp-inbound-channel-adapter-xml-01-co" id="amqp-inbound-channel-adapter-xml-01">
                <para>Unique ID for this adapter.
                <emphasis>Optional</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-02-co" id="amqp-inbound-channel-adapter-xml-02">
                <para>Message Channel to which converted Messages should be sent.
                <emphasis>Required</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-03-co" id="amqp-inbound-channel-adapter-xml-03">
                <para>Names of the AMQP Queues from which Messages should be
                      consumed (comma-separated list).
                <emphasis>Required</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-04-co" id="amqp-inbound-channel-adapter-xml-04">
                <para>Acknowledge Mode for the <interface>MessageListenerContainer</interface>.
                When set to MANUAL, the delivery tag and channel are provided in
                message headers <code>amqp_deliveryTag</code> and
                <code>amqp_channel</code> respectively; the user application is
                responsible for acknowledgement. NONE means no acknowledgements
                (autoAck); AUTO means the adapter's container will acknowledge
                when the downstream flow completes.
                <emphasis>Optional (Defaults to AUTO)</emphasis> see <xref linkend="amqp-inbound-ack"/>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-05-co" id="amqp-inbound-channel-adapter-xml-05">
                <para>Extra AOP Advice(s) to handle cross cutting behavior associated with this Inbound Channel Adapter.
                <emphasis>Optional</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-06-co" id="amqp-inbound-channel-adapter-xml-06">
                <para>Flag to indicate that channels created by this component
                      will be transactional. Ff true, tells the framework to use
                      a transactional channel and to end all operations (send or
                      receive) with a commit or rollback depending on the outcome,
                      with an exception signalling a rollback.
                <emphasis>Optional (Defaults to false)</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-07-co" id="amqp-inbound-channel-adapter-xml-07">
                <para>Specify the number of concurrent consumers to create.
                      Default is 1. Raising the number of concurrent consumers
                      is recommended in order to scale the consumption of
                      messages coming in from a queue. However, note that any
                      ordering guarantees are lost once multiple consumers are
                      registered. In general, stick with 1 consumer for
                      low-volume queues.
                <emphasis>Optional</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-08-co" id="amqp-inbound-channel-adapter-xml-08">
                <para>Bean reference to the RabbitMQ ConnectionFactory.
                <emphasis>Optional (Defaults to 'connectionFactory')</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-09-co" id="amqp-inbound-channel-adapter-xml-09">
                <para>Message Channel to which error Messages should be sent.
                <emphasis>Optional</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-10-co" id="amqp-inbound-channel-adapter-xml-10">
                <para>Shall the listener channel (com.rabbitmq.client.Channel) be
                      exposed to a registered <interface>ChannelAwareMessageListener</interface>.
                <emphasis>Optional (Defaults to true)</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-11-co" id="amqp-inbound-channel-adapter-xml-11">
                <para>A reference to an <interfacename>AmqpHeaderMapper</interfacename> to use when receiving AMQP Messages.
                <emphasis>Optional</emphasis>.
                By default only standard AMQP properties (e.g. <code>contentType</code>) will be copied to
 			    Spring Integration <classname>MessageHeaders</classname>. Any user-defined headers within the AMQP
                <classname>MessageProperties</classname> will NOT be copied to the Message by the default
                <classname>DefaultAmqpHeaderMapper</classname>.
                Not allowed if 'request-header-names' is provided.
                </para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-12-co" id="amqp-inbound-channel-adapter-xml-12">
                <para>Comma-separated list of names of AMQP Headers to be mapped from the AMQP request into the MessageHeaders.
                This can only be provided if the 'header-mapper' reference is not provided. The values in
                this list can also be simple patterns to be matched against the header names (e.g. "*" or "foo*, bar" or "*foo").</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-14-co" id="amqp-inbound-channel-adapter-xml-14">
                <para>Reference to the <interfacename>SimpleMessageListenerContainer</interfacename>
                      to use for receiving AMQP Messages. If this attribute is provided,
                      then no other attribute related to the listener container
                      configuration should be provided. In other words, by
                      setting this reference, you must take full responsibility
                      of the listener container configuration. The only exception
                      is the MessageListener itself. Since that is actually the
                      core responsibility of this Channel Adapter implementation,
                      the referenced listener container must NOT already have its
                      own MessageListener configured.
                <emphasis>Optional</emphasis>.
                <note>
                  Note that when configuring an external container, you cannot use the <emphasis role="bold">Spring AMQP</emphasis>
                  namespace to define the container. This is because the namespace requires at least one <code>&lt;listener/&gt;</code>
                  element. In this environment, the listener is internal to the adapter. For this reason, you must define
                  the container using a normal Spring <code>&lt;bean/&gt;</code> definition, such as:
                  <programlisting language="xml"><![CDATA[
<bean id="container"
 class="org.springframework.amqp.rabbit.listener.SimpleMessageListenerContainer">
	<property name="connectionFactory" ref="connectionFactory" />
	<property name="queueNames" value="foo.queue" />
	<property name="defaultRequeueRejected" value="false"/>
</bean>]]></programlisting>
                </note></para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-15-co" id="amqp-inbound-channel-adapter-xml-15">
                <para>The MessageConverter to use when receiving AMQP Messages.
                <emphasis>Optional</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-16-co" id="amqp-inbound-channel-adapter-xml-16">
                <para>The MessagePropertiesConverter to use when receiving AMQP Messages.
                <emphasis>Optional</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-17-co" id="amqp-inbound-channel-adapter-xml-17">
                <para>Specify the phase in which the underlying <interface>SimpleMessageListenerContainer</interface>
                      should be started and stopped. The startup order proceeds
                      from lowest to highest, and the shutdown order is the
                      reverse of that. By default this value is Integer.MAX_VALUE
                      meaning that this container starts as late as possible and
                      stops as soon as possible.
                <emphasis>Optional</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-18-co" id="amqp-inbound-channel-adapter-xml-18">
                <para>Tells the AMQP broker how many messages to send to each
                      consumer in a single request. Often this can be set quite
                      high to improve throughput. It should be greater than or
                      equal to the transaction size (see attribute "tx-size").
                <emphasis>Optional (Defaults to 1)</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-19-co" id="amqp-inbound-channel-adapter-xml-19">
                <para>Receive timeout in milliseconds.
                <emphasis>Optional (Defaults to 1000)</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-20-co" id="amqp-inbound-channel-adapter-xml-20">
                <para>Specifies the interval between recovery attempts of the underlying
                      <interface>SimpleMessageListenerContainer</interface> (in
                      milliseconds).
                <emphasis>Optional (Defaults to 5000)</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-20d-co" id="amqp-inbound-channel-adapter-xml-20d">
                <para>	If 'true', and none of the queues are available on the broker, the container
                will throw a fatal exception during startup and will stop if the queues are deleted when
                the container is running (after making 3 attempts to passively declare the queues). If false,
                the container will not throw an exception and go into recovery mode, attempting to restart according
                to the <code>revcovery-interval</code>.
                <emphasis>Optional (Defaults to <code>true</code>)</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-21-co" id="amqp-inbound-channel-adapter-xml-21">
                <para>The time to wait for workers in milliseconds after the
                      underlying <interface>SimpleMessageListenerContainer</interface>
                      is stopped, and before the AMQP connection is forced closed.
                      If any workers are active when the shutdown signal comes
                      they will be allowed to finish processing as long as they
                      can finish within this timeout. Otherwise the connection is
                      closed and messages remain unacked (if the channel is
                      transactional). Defaults to 5000 milliseconds.
                <emphasis>Optional (Defaults to 5000)</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-22-co" id="amqp-inbound-channel-adapter-xml-22">
                <para>By default, the underlying <interface>SimpleMessageListenerContainer</interface>
                      uses a SimpleAsyncTaskExecutor implementation, that fires
                      up a new Thread for each task, executing it asynchronously.
                      By default, the number of concurrent threads is unlimited.

                      NOTE: This implementation does not reuse threads. Consider
                      a thread-pooling TaskExecutor implementation as an alternative.
                <emphasis>Optional (Defaults to SimpleAsyncTaskExecutor)</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-23-co" id="amqp-inbound-channel-adapter-xml-23">
                <para>By default the underlying <interface>SimpleMessageListenerContainer</interface>
                      creates a new instance of the DefaultTransactionAttribute (takes
                      the EJB approach to rolling back on runtime, but not checked
                      exceptions.
                <emphasis>Optional (Defaults to DefaultTransactionAttribute)</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-24-co" id="amqp-inbound-channel-adapter-xml-24">
                <para>Sets a Bean reference to an external
                      <interface>PlatformTransactionManager</interface> on the
                      underlying SimpleMessageListenerContainer. The transaction
                      manager works in conjunction with the "channel-transacted"
                      attribute.

                      If there is already a transaction in progress when the
                      framework is sending or receiving a message, and the
                      channelTransacted flag is true, then the commit or rollback
                      of the messaging transaction will be deferred until the
                      end of the current transaction. If the channelTransacted
                      flag is false, then no transaction semantics apply to the
                      messaging operation (it is auto-acked). For further information
                      see chapter 1.9 of the Spring AMQP reference guide:

                      http://static.springsource.org/spring-amqp/docs/1.0.x/reference/html/#d0e525
                <emphasis>Optional</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-inbound-channel-adapter-xml-25-co" id="amqp-inbound-channel-adapter-xml-25">
                <para>Tells the <interface>SimpleMessageListenerContainer</interface>
                      how many messages to process in a single transaction (if
                      the channel is transactional). For best results it should
                      be less than or equal to the set "prefetch-count".
                <emphasis>Optional (Defaults to 1)</emphasis>.</para>
            </callout>
        </calloutlist>
    </para>
    <important>
        <para>Even though the Spring Integration JMS and AMQP support is very similar,
              important differences exist. The JMS Inbound Channel Adapter is using a
              JmsDestinationPollingSource under the covers and expects a configured Poller.

              The AMQP Inbound Channel Adapter on the other side uses a
              <interface>SimpleMessageListenerContainer</interface> and is message
              driven. In that regard it is more similar to the JMS Message
              Driven Channel Adapter.</para>
    </important>
  </section>

  <section id="amqp-inbound-gateway">
      <title>Inbound Gateway</title>
      <para>The inbound gateway supports all the attributes on the inbound channel adapter (except 'channel'
      is replaced by 'request-channel'), plus some additional attributes:</para>
      <programlisting language="xml"><![CDATA[<int-amqp:inbound-gateway
                          id="inboundGateway"]]><co                   id="amqp-inbound-gateway-adapter-xml-1-co" linkends="amqp-inbound-gateway-adapter-xml-1" /><![CDATA[
                          request-channel="myRequestChannel"]]><co     id="amqp-inbound-gateway-adapter-xml-2-co" linkends="amqp-inbound-gateway-adapter-xml-2" /><![CDATA[
                          header-mapper=""]]><co                       id="amqp-inbound-gateway-adapter-xml-8-co" linkends="amqp-inbound-gateway-adapter-xml-8" /><![CDATA[
                          mapped-request-headers=""]]><co              id="amqp-inbound-gateway-adapter-xml-9-co" linkends="amqp-inbound-gateway-adapter-xml-9" /><![CDATA[
                          mapped-reply-headers=""]]><co                id="amqp-inbound-gateway-adapter-xml-10-co" linkends="amqp-inbound-gateway-adapter-xml-10" /><![CDATA[
                          reply-channel="myReplyChannel"]]><co         id="amqp-inbound-gateway-adapter-xml-11-co" linkends="amqp-inbound-gateway-adapter-xml-11" /><![CDATA[
                          reply-timeout="1000"]]><co                   id="amqp-inbound-gateway-adapter-xml-12-co" linkends="amqp-inbound-gateway-adapter-xml-12" /><![CDATA[/>]]>
      </programlisting>
      <para>
          <calloutlist>
              <callout arearefs="amqp-inbound-gateway-adapter-xml-1-co" id="amqp-inbound-gateway-adapter-xml-1">
                  <para>Unique ID for this adapter.
                  <emphasis>Optional</emphasis>.</para>
              </callout>
              <callout arearefs="amqp-inbound-gateway-adapter-xml-2-co" id="amqp-inbound-gateway-adapter-xml-2">
                  <para>Message Channel to which converted Messages should be sent.
                        <emphasis>Required</emphasis>.</para>
              </callout>
            <callout arearefs="amqp-inbound-gateway-adapter-xml-8-co" id="amqp-inbound-gateway-adapter-xml-8">
                <para>A reference to an <interfacename>AmqpHeaderMapper</interfacename> to use when receiving AMQP Messages.
                <emphasis>Optional</emphasis>.
                By default only standard AMQP properties (e.g. <code>contentType</code>) will be copied to and from
 			    Spring Integration <classname>MessageHeaders</classname>. Any user-defined headers within the AMQP
                <classname>MessageProperties</classname> will NOT be copied to or from an AMQP Message by the default
                <classname>DefaultAmqpHeaderMapper</classname>.
                Not allowed if 'request-header-names' or 'reply-header-names' is provided.
                </para>
            </callout>
            <callout arearefs="amqp-inbound-gateway-adapter-xml-9-co" id="amqp-inbound-gateway-adapter-xml-9">
                <para>Comma-separated list of names of AMQP Headers to be mapped from the AMQP request into the
					<classname>MessageHeaders</classname>.
                This can only be provided if the 'header-mapper' reference is not provided. The values in
                this list can also be simple patterns to be matched against the header names (e.g. "*" or "foo*, bar" or "*foo").</para>
            </callout>
            <callout arearefs="amqp-inbound-gateway-adapter-xml-10-co" id="amqp-inbound-gateway-adapter-xml-10">
                <para>Comma-separated list of names of <classname>MessageHeaders</classname> to be mapped into the
					AMQP Message Properties of the AMQP reply message.
	                All standard Headers (e.g., <code>contentType</code>) will be mapped to AMQP Message Properties
					while user-defined headers will be mapped to the 'headers' property.
	                This can only be provided if the 'header-mapper' reference is not provided. The values in
	                this list can also be simple patterns to be matched against the header names (e.g. "*" or "foo*,
					bar" or "*foo").</para>
            </callout>
              <callout arearefs="amqp-inbound-gateway-adapter-xml-11-co" id="amqp-inbound-gateway-adapter-xml-11">
                  <para>Message Channel where reply Messages will be expected.
                  <emphasis>Optional</emphasis>.</para>
              </callout>
              <callout arearefs="amqp-inbound-gateway-adapter-xml-12-co" id="amqp-inbound-gateway-adapter-xml-12">
				<para>Used to set the <code>receiveTimeout</code> on the underlying
					<classname>org.springframework.integration.core.MessagingTemplate</classname> for receiving messages
				from the reply channel. If not specified this property will default to "1000"
				(1 second). Only applies if the container thread hands off to another thread
				before the reply is sent.</para>
              </callout>
          </calloutlist>
      </para>
      <para>
        See the note in <xref linkend="amqp-inbound-channel-adapter"/> about configuring the <code>listener-container</code>
        attribute.
      </para>
  </section>

  <section id="amqp-inbound-ack">
    <title>Inbound Endpoint Acknowledge Mode</title>
    <para>
      By default the inbound endpoints use acknowledge mode <code>AUTO</code>, which means the container
      automatically <emphasis>acks</emphasis> the message when the downstream integration flow completes (or a message is
      handed off to another thread using a <classname>QueueChannel</classname> or <classname>ExecutorChannel</classname>).
      Setting the mode to <code>NONE</code> configures the consumer such that acks are not used at all
      (the broker automatically acks the message as soon as it is sent). Setting the mode to
      <code>MANUAL</code> allows user code to ack the message at some other point during processing.
      To support this, with this mode, the endpoints provide the <classname>Channel</classname> and
      <code>deliveryTag</code> in the <code>amqp_channel</code> and <code>amqp_deliveryTag</code>
      headers respectively.
    </para>
    <para>
      You can perform any valid rabbit command on the <classname>Channel</classname> but, generally, only
      <code>basicAck</code> and <code>basicNack</code> (or <code>basicReject</code>) would be used.
      In order to not interfere with the operation of the container, you should not retain a reference
      to the channel and just use it in the context of the current message.
    </para>
    <note>
      Since the <classname>Channel</classname> is a reference to a "live" object, it cannot be serialized
      and will be lost if a message is persisted.
    </note>
    <para>
      This is an example of how you might use <code>MANUAL</code> acknowledgement:
    </para>
    <programlisting language="java"><![CDATA[@ServiceActivator(inputChannel = "foo", outputChannel = "bar")
public Object handle(@Payload String payload, @Header(AmqpHeaders.CHANNEL) Channel channel,
        @Header(AmqpHeaders.DELIVERY_TAG) Long deliveryTag) throws Exception {

    // Do some processing

    if (allOK) {
        channel.basicAck(deliveryTag, false);

        // perhaps do some more processing

    }
    else {
        channel.basicNack(deliveryTag, false, true);
    }
    return someResultForDownStreamProcessing;
}]]></programlisting>
  </section>

  <section id="amqp-outbound-channel-adapter">
    <title>Outbound Channel Adapter</title>

    <para>A configuration sample for an AMQP Outbound Channel Adapter is shown
          below.</para>
    <programlisting language="xml"><![CDATA[<int-amqp:outbound-channel-adapter id="outboundAmqp"]]><co              id="amqp-outbound-channel-adapter-xml-1-co" linkends="amqp-outbound-channel-adapter-xml-1" /><![CDATA[
                               channel="outboundChannel"]]><co      id="amqp-outbound-channel-adapter-xml-2-co" linkends="amqp-outbound-channel-adapter-xml-2" /><![CDATA[
                               amqp-template="myAmqpTemplate"]]><co id="amqp-outbound-channel-adapter-xml-3-co" linkends="amqp-outbound-channel-adapter-xml-3" /><![CDATA[
                               exchange-name=""]]><co               id="amqp-outbound-channel-adapter-xml-4-co" linkends="amqp-outbound-channel-adapter-xml-4" /><![CDATA[
                               exchange-name-expression=""]]><co    id="amqp-outbound-channel-adapter-xml-4d-co" linkends="amqp-outbound-channel-adapter-xml-4d" /><![CDATA[
                               order="1"]]><co                      id="amqp-outbound-channel-adapter-xml-5-co" linkends="amqp-outbound-channel-adapter-xml-5" /><![CDATA[
                               routing-key=""]]><co                 id="amqp-outbound-channel-adapter-xml-6-co" linkends="amqp-outbound-channel-adapter-xml-6" /><![CDATA[
                               routing-key-expression=""]]><co      id="amqp-outbound-channel-adapter-xml-7-co" linkends="amqp-outbound-channel-adapter-xml-7" /><![CDATA[
                               default-delivery-mode""]]><co        id="amqp-outbound-channel-adapter-xml-7a-co" linkends="amqp-outbound-channel-adapter-xml-7a" /><![CDATA[
                               confirm-correlation-expression=""]]><co id="amqp-outbound-channel-adapter-xml-8-co" linkends="amqp-outbound-channel-adapter-xml-8" /><![CDATA[
                               confirm-ack-channel=""]]><co         id="amqp-outbound-channel-adapter-xml-9-co" linkends="amqp-outbound-channel-adapter-xml-9" /><![CDATA[
                               confirm-nack-channel=""]]><co        id="amqp-outbound-channel-adapter-xml-10-co" linkends="amqp-outbound-channel-adapter-xml-10" /><![CDATA[
                               return-channel=""]]><co              id="amqp-outbound-channel-adapter-xml-11-co" linkends="amqp-outbound-channel-adapter-xml-11" /><![CDATA[
                               header-mapper=""]]><co               id="amqp-outbound-channel-adapter-xml-12-co" linkends="amqp-outbound-channel-adapter-xml-12" /><![CDATA[
                               mapped-request-headers=""]]><co      id="amqp-outbound-channel-adapter-xml-13-co" linkends="amqp-outbound-channel-adapter-xml-13" /><![CDATA[
                               lazy-connect="true"]]><co            id="amqp-outbound-channel-adapter-xml-14-co" linkends="amqp-outbound-channel-adapter-xml-14" /><![CDATA[/>]]>
    </programlisting>
    <para>
        <calloutlist>
	        <callout arearefs="amqp-outbound-channel-adapter-xml-1-co" id="amqp-outbound-channel-adapter-xml-1">
	            <para>Unique ID for this adapter.
	            <emphasis>Optional</emphasis>.</para>
	        </callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-2-co" id="amqp-outbound-channel-adapter-xml-2">
                <para>Message Channel to which Messages should be sent
					  in order to have them converted and published to an
					  AMQP Exchange.
                <emphasis>Required</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-3-co" id="amqp-outbound-channel-adapter-xml-3">
                <para>Bean Reference to the configured AMQP Template
                <emphasis>Optional (Defaults to "amqpTemplate")</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-4-co" id="amqp-outbound-channel-adapter-xml-4">
                <para>The name of the AMQP Exchange to which Messages
					  should be sent. If not provided, Messages will be sent
					  to the default, no-name Exchange. Mutually exclusive with 'exchange-name-expression'.
                <emphasis>Optional</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-4d-co" id="amqp-outbound-channel-adapter-xml-4d">
                <para>A SpEL expression that is evaluated to determine the name of the AMQP Exchange to which Messages
					  should be sent, with the message as the root object. If not provided, Messages will be sent
					  to the default, no-name Exchange. Mutually exclusive with 'exchange-name'.
                <emphasis>Optional</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-5-co" id="amqp-outbound-channel-adapter-xml-5">
                <para>The order for this consumer when multiple
					  consumers are registered thereby enabling load-
					  balancing and/or failover.
                <emphasis>Optional (Defaults to Ordered.LOWEST_PRECEDENCE [=Integer.MAX_VALUE])</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-6-co" id="amqp-outbound-channel-adapter-xml-6">
                <para>The fixed routing-key to use when sending Messages. By
                      default, this will be an empty String. Mutually exclusive with 'routing-key-expression'.
                <emphasis>Optional</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-7-co" id="amqp-outbound-channel-adapter-xml-7">
                <para>A SpEL expression that is evaluated to determine the routing-key to use when sending Messages,
					  with the message as the root object (e.g. 'payload.key'). By default, this will be an empty
					String. Mutually exclusive with 'routing-key'.
                <emphasis>Optional</emphasis>.</para>
            </callout>
			<callout arearefs="amqp-outbound-channel-adapter-xml-7a-co" id="amqp-outbound-channel-adapter-xml-7a">
				<para>
				The default delivery mode for messages; 'PERSISTENT' or 'NON_PERSISTENT'. Overridden if the 'header-mapper'
				sets the delivery mode. The 'DefaultHeaderMapper' sets the value if the
				Spring Integration message header <code>amqp_deliveryMode</code>
				is present. If this attribute is not supplied and
				the header mapper doesn't set it, the default depends on the underlying spring-amqp 'MessagePropertiesConverter'
				used by the 'RabbitTemplate'. If that is not customized at all, the default is 'PERSISTENT'.
				<emphasis>Optional</emphasis>.</para>
			</callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-8-co" id="amqp-outbound-channel-adapter-xml-8">
                <para>An expression defining correlation data. When provided, this configures the underlying
                amqp template to receive publisher confirms. Requires a dedicated
                <classname>RabbitTemplate</classname> and a
                <classname>CachingConnectionFactory</classname> with the <code>publisherConfirms</code> property
                set to <code>true</code>. When a publisher confirm
                is received, and correlation data is supplied,
                it is written to either the confirm-ack-channel, or the confirm-nack-channel,
                depending on the confirmation type. The payload of the confirm is the correlation data as
                defined by this expression and the message will have a header 'amqp_publishConfirm' set to
                true (ack) or false (nack). Examples: "headers['myCorrelationData']", "payload".
                <emphasis>Optional</emphasis>.</para>
				<para>
					Starting with <emphasis>version 4.1</emphasis> the <code>amqp_publishConfirmNackCause</code>
					message header has been added. It contains the <code>cause</code> of a 'nack' for publisher
					confirms.
				</para>
            </callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-9-co" id="amqp-outbound-channel-adapter-xml-9">
                <para>The channel to which positive (ack) publisher confirms are sent; payload is
                the correlation data defined by the <emphasis>confirm-correlation-expression</emphasis>.
                <emphasis>Optional, default=nullChannel</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-10-co" id="amqp-outbound-channel-adapter-xml-10">
                <para>The channel to which negative (nack) publisher confirms are sent; payload is
                the correlation data defined by the <emphasis>confirm-correlation-expression</emphasis>.
                <emphasis>Optional, default=nullChannel</emphasis>.</para>
            </callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-11-co" id="amqp-outbound-channel-adapter-xml-11">
                <para>The channel to which returned messages are sent. When provided, the underlying amqp template
                is configured to return undeliverable messages to the adapter. The message will be constructed from the
                data received from amqp, with the following additional headers: <emphasis>amqp_returnReplyCode,
                amqp_returnReplyText, amqp_returnExchange, amqp_returnRoutingKey</emphasis>.
                <emphasis>Optional</emphasis>.</para>
                <important>
                  Using a <code>return-channel</code> requires a <classname>RabbitTemplate</classname> with
                  the <code>mandatory</code> property set to <code>true</code>,
                  and a <classname>CachingConnectionFactory</classname>
                  with the <code>publisherReturns</code> property set to <code>true</code>. When using multiple
                  outbound endpoints with returns, a separate <classname>RabbitTemplate</classname> is needed
                  for each endpoint.
                </important>
            </callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-12-co" id="amqp-outbound-channel-adapter-xml-12">
                <para>A reference to an <interfacename>AmqpHeaderMapper</interfacename> to use when sending AMQP Messages.
                <emphasis>Optional</emphasis>.
                By default only standard AMQP properties (e.g. <code>contentType</code>) will be copied to the
					Spring Integration <classname>MessageHeaders</classname>.
					Any user-defined headers will NOT be copied to the Message by the default
					<classname>DefaultAmqpHeaderMapper</classname>.
                    Not allowed if 'request-header-names' is provided.
                </para>
            </callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-13-co" id="amqp-outbound-channel-adapter-xml-13">
                <para>Comma-separated list of names of AMQP Headers to be mapped from the
					<classname>MessageHeaders</classname> to the AMQP Message.
                Not allowed if the 'header-mapper' reference is provided. The values in
                this list can also be simple patterns to be matched against the header names (e.g. "*" or "foo*, bar" or "*foo").</para>
            </callout>
            <callout arearefs="amqp-outbound-channel-adapter-xml-14-co" id="amqp-outbound-channel-adapter-xml-14">
                <para>When set to <code>false</code>, the endpoint will attempt to connect to the
                broker during application context initialization. This allows "fail fast" detection of
                bad configuration, but will also cause initialization to fail if the broker is down.
                When true (default), the connection is established (if it doesn't already exist because
                some other component established it) when the first message is sent.</para>
            </callout>
        </calloutlist>
    </para>
  </section>

  <section id="amqp-outbound-gateway">
      <title>Outbound Gateway</title>
      <para>A configuration sample for an AMQP Outbound Gateway is shown
            below.</para>
      <programlisting language="xml"><![CDATA[<int-amqp:outbound-gateway id="inboundGateway"]]><co                id="amqp-outbound-gateway-adapter-xml-1-co" linkends="amqp-outbound-gateway-adapter-xml-1" /><![CDATA[
                           request-channel="myRequestChannel"]]><co id="amqp-outbound-gateway-adapter-xml-2-co" linkends="amqp-outbound-gateway-adapter-xml-2" /><![CDATA[
                           amqp-template=""]]><co                   id="amqp-outbound-gateway-adapter-xml-3-co" linkends="amqp-outbound-gateway-adapter-xml-3" /><![CDATA[
                           exchange-name=""]]><co                   id="amqp-outbound-gateway-adapter-xml-4-co" linkends="amqp-outbound-gateway-adapter-xml-4" /><![CDATA[
                           exchange-name-expression=""]]><co        id="amqp-outbound-gateway-adapter-xml-4d-co" linkends="amqp-outbound-gateway-adapter-xml-4d" /><![CDATA[
                           order="1"]]><co                          id="amqp-outbound-gateway-adapter-xml-5-co" linkends="amqp-outbound-gateway-adapter-xml-5" /><![CDATA[
                           reply-channel=""]]><co                   id="amqp-outbound-gateway-adapter-xml-6-co" linkends="amqp-outbound-gateway-adapter-xml-6" /><![CDATA[
                           reply-channel=""]]><co                   id="amqp-outbound-gateway-adapter-xml-6a-co" linkends="amqp-outbound-gateway-adapter-xml-6a" /><![CDATA[
                           requires-reply=""]]><co                   id="amqp-outbound-gateway-adapter-xml-6b-co" linkends="amqp-outbound-gateway-adapter-xml-6b" /><![CDATA[
                           routing-key=""]]><co                     id="amqp-outbound-gateway-adapter-xml-7-co" linkends="amqp-outbound-gateway-adapter-xml-7" /><![CDATA[
                           routing-key-expression=""]]><co          id="amqp-outbound-gateway-adapter-xml-8-co" linkends="amqp-outbound-gateway-adapter-xml-8" /><![CDATA[
                           default-delivery-mode""]]><co            id="amqp-outbound-gateway-adapter-xml-8a-co" linkends="amqp-outbound-gateway-adapter-xml-8a" /><![CDATA[
                           return-channel=""]]><co                  id="amqp-outbound-gateway-adapter-xml-9-co" linkends="amqp-outbound-gateway-adapter-xml-9" /><![CDATA[
                           lazy-connect="true"]]><co               id="amqp-outbound-gateway-adapter-xml-10-co" linkends="amqp-outbound-gateway-adapter-xml-10" /><![CDATA[/>]]>
      </programlisting>
      <para>
          <calloutlist>
              <callout arearefs="amqp-outbound-gateway-adapter-xml-1-co" id="amqp-outbound-gateway-adapter-xml-1">
                  <para>Unique ID for this adapter.
                  <emphasis>Optional</emphasis>.</para>
              </callout>
              <callout arearefs="amqp-outbound-gateway-adapter-xml-2-co" id="amqp-outbound-gateway-adapter-xml-2">
                  <para>Message Channel to which Messages should be sent
                        in order to have them converted and published to an
                        AMQP Exchange.
                        <emphasis>Required</emphasis>.</para>
              </callout>
              <callout arearefs="amqp-outbound-gateway-adapter-xml-3-co" id="amqp-outbound-gateway-adapter-xml-3">
                  <para>Bean Reference to the configured AMQP Template
                  <emphasis>Optional (Defaults to "amqpTemplate")</emphasis>.</para>
              </callout>
              <callout arearefs="amqp-outbound-gateway-adapter-xml-4-co" id="amqp-outbound-gateway-adapter-xml-4">
                  <para>The name of the AMQP Exchange to which Messages should
                        be sent. If not provided, Messages will be sent to the
                        default, no-name Exchange. Mutually exclusive with 'exchange-name-expression'.
                  <emphasis>Optional</emphasis>.</para>
              </callout>
              <callout arearefs="amqp-outbound-gateway-adapter-xml-4d-co" id="amqp-outbound-gateway-adapter-xml-4d">
                <para>A SpEL expression that is evaluated to determine the name of the AMQP Exchange to which Messages
					  should be sent, with the message as the root object. If not provided, Messages will be sent
					  to the default, no-name Exchange. Mutually exclusive with 'exchange-name'.
                <emphasis>Optional</emphasis>.</para>
              </callout>
              <callout arearefs="amqp-outbound-gateway-adapter-xml-5-co" id="amqp-outbound-gateway-adapter-xml-5">
                  <para>The order for this consumer when multiple
                        consumers are registered thereby enabling load-
                        balancing and/or failover.
                  <emphasis>Optional (Defaults to Ordered.LOWEST_PRECEDENCE [=Integer.MAX_VALUE])</emphasis>.</para>
              </callout>
              <callout arearefs="amqp-outbound-gateway-adapter-xml-6-co" id="amqp-outbound-gateway-adapter-xml-6">
                  <para>Message Channel to which replies should be sent after
                        being received from an AQMP Queue and converted.
                  <emphasis>Optional</emphasis>.</para>
              </callout>
              <callout arearefs="amqp-outbound-gateway-adapter-xml-6a-co" id="amqp-outbound-gateway-adapter-xml-6a">
                  <para>The time the gateway will wait when sending the reply message to the <code>reply-channel</code>.
                  This only applies if the <code>reply-channel</code> can block - such as a
                  <classname>QueueChannel</classname> with a capacity limit that is currently full. Default: infinity.</para>
              </callout>
              <callout arearefs="amqp-outbound-gateway-adapter-xml-6b-co" id="amqp-outbound-gateway-adapter-xml-6b">
                  <para>When <code>true</code>, the gateway will throw an exception if no reply message is received
					  within the <classname>AmqpTemplate</classname>'s <code>replyTimeout</code> property. Default:
					  <code>true</code>.</para>
              </callout>
              <callout arearefs="amqp-outbound-gateway-adapter-xml-7-co" id="amqp-outbound-gateway-adapter-xml-7">
                  <para>The routing-key to use when sending Messages. By default,
                        this will be an empty String. Mutually exclusive with 'routing-key-expression'
                  <emphasis>Optional</emphasis>.</para>
              </callout>
              <callout arearefs="amqp-outbound-gateway-adapter-xml-8-co" id="amqp-outbound-gateway-adapter-xml-8">
                <para>A SpEL expression that is evaluated to determine the routing-key to use when sending Messages,
					  with the message as the root object (e.g. 'payload.key'). By default, this will be an empty
					String. Mutually exclusive with 'routing-key'.
                  <emphasis>Optional</emphasis>.</para>
              </callout>
              <callout arearefs="amqp-outbound-gateway-adapter-xml-8a-co" id="amqp-outbound-gateway-adapter-xml-7a">
                  <para>
                  The default delivery mode for messages; 'PERSISTENT' or 'NON_PERSISTENT'. Overridden if the 'header-mapper'
                  sets the delivery mode. The 'DefaultHeaderMapper' sets the value if the
                  Spring Integration message header <code>amqp_deliveryMode</code>
                  is present. If this attribute is not supplied and
                  the header mapper doesn't set it, the default depends on the underlying spring-amqp 'MessagePropertiesConverter'
                  used by the 'RabbitTemplate'. If that is not customized at all, the default is 'PERSISTENT'.
                  <emphasis>Optional</emphasis>.</para>
              </callout>
              <callout arearefs="amqp-outbound-gateway-adapter-xml-9-co" id="amqp-outbound-gateway-adapter-xml-9">
                <para>The channel to which returned messages are sent. When provided, the underlying amqp template
                is configured to return undeliverable messages to the gateway. The message will be constructed from the
                data received from amqp, with the following additional headers: <emphasis>amqp_returnReplyCode,
                amqp_returnReplyText, amqp_returnExchange, amqp_returnRoutingKey</emphasis>.
                <emphasis>Optional</emphasis>.</para>
                <important>
                  Using a <code>return-channel</code> requires a <classname>RabbitTemplate</classname> with
                  the <code>mandatory</code> property set to <code>true</code>,
                  and a <classname>CachingConnectionFactory</classname>
                  with the <code>publisherReturns</code> property set to <code>true</code>. When using multiple
                  outbound endpoints with returns, a separate <classname>RabbitTemplate</classname> is needed
                  for each endpoint.
                </important>
              </callout>
            <callout arearefs="amqp-outbound-gateway-adapter-xml-10-co" id="amqp-outbound-gateway-adapter-xml-10">
                <para>When set to <code>false</code>, the endpoint will attempt to connect to the
                broker during application context initialization. This allows "fail fast" detection of
                bad configuration, but will also cause initialization to fail if the broker is down.
                When true (default), the connection is established (if it doesn't already exist because
                some other component established it) when the first message is sent.</para>
            </callout>
          </calloutlist>
      </para>
      <note>
        <para>Prior to Spring Integration 2.2, and Spring AMQP 1.1, the outbound gateway used a new, temporary,
        reply queue for each request. This is still the default, but now the RabbitTemplate can be configured
        with a specific queue for replies; headers are added to the outbound message for request/reply correlation.
        It is important that the consuming application returns these headers unchanged. The headers are
        <classname>spring_reply_correlation</classname> and <classname>spring_reply_to</classname>. If
        the consuming application is a Spring Integration application, these headers will be managed
        automatically, including the case where that application might send a request/reply to a third
        application using an outbound gateway.</para>
      </note>
      <important>
        The underlying <classname>AmqpTemplate</classname> has a default <code>replyTimeout</code> of
        5 seconds. If you require a longer timeout, it must be configured on the <code>template</code>.
      </important>
  </section>

  <section id="amqp-channels">
    <title>AMQP Backed Message Channels</title>

    <para>
        There are two Message Channel implementations available. One is point-to-point, and the other is publish/subscribe.
		Both of these channels provide a wide range of configuration attributes for the underlying AmqpTemplate and
		SimpleMessageListenerContainer as you have seen on the Channel Adapters and Gateways. However, the examples we'll
		show here are going to have minimal configuration. Explore the XML schema to view the available attributes.
    </para>
	<para>
		A point-to-point channel would look like this:
		<programlisting language="xml"><![CDATA[<int-amqp:channel id="p2pChannel"/>]]></programlisting>
		Under the covers a Queue named "si.p2pChannel" would be declared, and this channel will send to
		that Queue (technically by sending to the no-name Direct Exchange with a routing key that matches this Queue's name).
		This channel will also register a consumer on that Queue. If for some reason, you want the Queue to be "pollable"
		instead of message-driven, then simply provide the "message-driven" flag with a value of false:
		<programlisting language="xml"><![CDATA[<int-amqp:channel id="p2pPollableChannel"  message-driven="false"/>]]></programlisting>
	</para>
	<para>
    	A publish/subscribe channel would look like this:
		<programlisting language="xml"><![CDATA[<int-amqp:publish-subscribe-channel id="pubSubChannel"/>]]></programlisting>
		Under the covers a Fanout Exchange named "si.fanout.pubSubChannel" would be declared, and this channel will send
		to that Fanout Exchange. This channel will also declare a server-named exclusive, autodelete, non-durable Queue
		and bind that to the Fanout Exchange while registering a consumer on that Queue to receive Messages. There is no
		"pollable" option for a publish-subscribe-channel; it must be message-driven.
	</para>
	  <para>
		  Starting with <emphasis>version 4.1</emphasis> AMQP Backed Message Channels, alongside with
		  <code>channel-transacted</code>, support <code>template-channel-transacted</code> to separate
		  <code>transactional</code> configuration for the <classname>AbstractMessageListenerContainer</classname>
		  and for the <classname>RabbitTemplate</classname>.
		  Note, previously, the <code>channel-transacted</code> was <code>true</code> by default, now it changed to
		  <code>false</code> as standard default value for the <classname>AbstractMessageListenerContainer</classname>.
	  </para>
  </section>
	<section id="amqp-message-headers">
		<title>AMQP Message Headers</title>
		<para>
			The Spring Integration AMPQ Adapters will map standard AMQP  properties
			automatically. These properties will be copied by default to and from
			Spring Integration <classname>MessageHeaders</classname> using the
			<classname><ulink url="http://static.springsource.org/spring-integration/api/org/springframework/integration/amqp/support/DefaultAmqpHeaderMapper.html">DefaultAmqpHeaderMapper</ulink></classname>.
		</para>
		<para>
			Of course, you can pass in your own implementation of AMQP specific header
			mappers, as the adapters have respective properties to support that.
		</para>
		<para>
			Any user-defined headers within the AMQP
			<classname><ulink url="http://static.springsource.org/spring-amqp/api/org/springframework/amqp/core/MessageProperties.html">MessageProperties</ulink></classname>
			will NOT be copied to or from an AMQP Message, unless explicitly specified
			by the <emphasis>requestHeaderNames</emphasis> and/or
			<emphasis>replyHeaderNames</emphasis> properties of the
			<classname>DefaultAmqpHeaderMapper</classname>.
		</para>
		<tip>
			When mapping user-defined headers, the values can also contain simple
			wildcard patterns (e.g. "foo*" or "*foo") to be matched. For example,
			if you need to copy all user-defined headers simply use the wild-card
			character '*'.
		</tip>
		<para>
			Starting with <emphasis>version 4.1</emphasis>, the <classname>AbstractHeaderMapper</classname>
			(a <classname>DefaultAmqpHeaderMapper</classname> superclass) allows the <code>NON_STANDARD_HEADERS</code>
			token to be configured for the <emphasis>requestHeaderNames</emphasis> and/or <emphasis>replyHeaderNames</emphasis>
			properties (in addition to existing <code>STANDARD_REQUEST_HEADERS</code> and <code>
			STANDARD_REPLY_HEADERS</code>) to map all user-defined headers. Note, it is recommended to use the
			combination like this <code>STANDARD_REPLY_HEADERS, NON_STANDARD_HEADERS</code> instead of
			generic <code>*</code>, to avoid mapping of <emphasis>request</emphasis> headers to the reply.
		</para>
		<para>
			Class <classname><ulink url="http://static.springsource.org/spring-integration/api/org/springframework/integration/amqp/AmqpHeaders.html">AmqpHeaders</ulink></classname>
			identifies the default headers that will be used by the
			<classname>DefaultAmqpHeaderMapper</classname>:
		</para>
		<itemizedlist>
			<listitem>amqp_appId</listitem>
			<listitem>amqp_clusterId</listitem>
			<listitem>amqp_contentEncoding</listitem>
			<listitem>amqp_contentLength</listitem>
			<listitem>content-type</listitem>
			<listitem>amqp_correlationId</listitem>
			<listitem>amqp_deliveryMode</listitem>
			<listitem>amqp_deliveryTag</listitem>
			<listitem>amqp_expiration</listitem>
			<listitem>amqp_messageCount</listitem>
			<listitem>amqp_messageId</listitem>
			<listitem>amqp_receivedExchange</listitem>
			<listitem>amqp_receivedRoutingKey</listitem>
			<listitem>amqp_redelivered</listitem>
			<listitem>amqp_replyTo</listitem>
			<listitem>amqp_timestamp</listitem>
			<listitem>amqp_type</listitem>
			<listitem>amqp_userId</listitem>
			<listitem>amqp_springReplyCorrelation</listitem>
			<listitem>amqp_springReplyToStack</listitem>
			<listitem>amqp_publishConfirm</listitem>
			<listitem>amqp_publishConfirmNackCause</listitem>
			<listitem>amqp_returnReplyCode</listitem>
			<listitem>amqp_returnReplyText</listitem>
			<listitem>amqp_returnExchange</listitem>
			<listitem>amqp_returnRoutingKey</listitem>
		</itemizedlist>
	</section>
	<section>
    <title>AMQP Samples</title>
    <para>
        To experiment with the AMQP adapters, check out the samples available in
        the Spring Integration Samples Git repository at:
    </para>
    <itemizedlist>
        <listitem><ulink url="https://github.com/SpringSource/spring-integration-samples">
           https://github.com/SpringSource/spring-integration-samples</ulink>
        </listitem>
    </itemizedlist>
    <para>
        Currently there is one sample available that demonstrates the basic
        functionality of the Spring Integration AMQP Adapter using an Outbound Channel Adapter
        and an Inbound Channel Adapter. As AMQP Broker implementation the sample
        uses RabbitMQ (<ulink url="http://www.rabbitmq.com/">http://www.rabbitmq.com/</ulink>).
    </para>
    <note>
        In order to run the example you will need a running instance of RabbitMQ.
        A local installation with just the basic defaults will be sufficient.
        For detailed RabbitMQ installation procedures please visit:
        <ulink url="http://www.rabbitmq.com/install.html">
            http://www.rabbitmq.com/install.html
        </ulink>
    </note>
    <para>
        Once the sample application is started, you enter some text on the command prompt
        and a message containing that entered text is dispatched to the AMQP queue.
        In return that message is retrieved via Spring Integration and then printed
        to the console.
    </para>
    <para>
        The image belows illustrates the basic set of Spring Integration components
        used in this sample.
    </para>
	<mediaobject>
	  <imageobject role="fo">
	      <imagedata fileref="images/spring-integration-amqp-sample-graph.png" format="PNG" align="center"  scalefit="1" width="100%" contentdepth="100%"/>
	  </imageobject>
	  <imageobject role="html">
	      <imagedata fileref="images/spring-integration-amqp-sample-graph.png" format="PNG" align="center"  scalefit="1" width="100%" contentdepth="100%"/>
	  </imageobject>
	</mediaobject>
	<caption>The Spring Integration graph of the AMQP sample</caption>
  </section>
</chapter>
